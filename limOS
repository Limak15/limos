#! /usr/bin/env bash

# Formatting
RESET="\033[0m" # Reset all foramting styles and colors
BOLD="\033[1m"
BOLDR="\033[22m" #Reset bold only styles

# Colors
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"

limos_repo_section="[limos-main-repo]\nSigLevel = Optional DatabaseOptional\nServer = https://gitlab.com/limakos/limos-main-repo/-/raw/master/"'$arch'
dynamic_theme=false

info() {
    echo -e "#######${BOLD}${YELLOW} INFO ${RESET}################################################################"
    echo -e "$1"
    echo -e "#############################################################################\n"
}

info " ${BOLD}LimOS${BOLDR} is a post installation script that will install\n\
 and configure window manager along with all applications\n\
 and utilities that are needed to create fully functional desktop environment.\n\
 This script for now should only be used in Arch Linux."

while true; do
    echo -n -e "${BOLD}Do you want to continue? (Yy Nn): ${BOLDR}"
    read choice

    case $choice in
        [Yy]* ) break;;
        [Nn]* ) exit;;
        * ) echo "Please answer yes or no."
    esac
done

info " ${BOLD}About dynamic theme: ${RESET} it's a script\n\
 that will change desktop theme and wallpaper every two hours.\n\
 You can see all themes here: https://gitlab.com/TODO\n\
 If you disable dynamic theme by default theme number 6 will be used"

while true; do
    echo -n -e "${BOLD}Do you want enable dynamic theme? (Yy Nn): ${BOLDR}"
    read choice

    case $choice in
        [Yy]* ) dynamic_theme=true;break;;
        [Nn]* ) break;;
        * ) echo "Please answer yes or no."
    esac
done

info " ${BOLD}Installing LimOS${BOLDR}"

info "${BOLD}Adding LimOS repository${RESET}"

#Backup pacman.conf file
sudo cp /etc/pacman.conf /etc/pacman.conf.bak 

echo -e $limos_repo_section | sudo tee -a /etc/pacman.conf

sudo pacman -Syy

info "${BOLD}Installing essential packages${RESET}"

sudo pacman -Sy --noconfirm --needed - < pkglist.txt

info "${BOLD}Configuring fonts${RESET}"

mkdir -p $HOME/.local/share/fonts/{ttf,otf}
cp -r /etc/limos/Feather $HOME/.local/share/fonts/ttf/
wget 'https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/Meslo.zip'
unzip Meslo.zip -d $HOME/.local/share/fonts/ttf/Meslo/
wget 'https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/Mononoki.zip'
unzip Mononoki.zip -d $HOME/.local/share/fonts/ttf/Mononoki/
wget 'https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/RobotoMono.zip'
unzip RobotoMono.zip -d $HOME/.local/share/fonts/ttf/RobotoMono/
chown $USER:$USER $HOME/.local/share/fonts/*
rm Meslo.zip Mononoki.zip RobotoMono.zip

info "${BOLD}Changing shell to zsh${RESET}"

sudo chsh $USER -s "/bin/zsh" 1> /dev/null 2> error.txt || err "Changing shell to zsh"

info "${BOLD}Installing zsh plugins${RESET}"

git clone 'https://github.com/zsh-users/zsh-autosuggestions' ~/.zsh/zsh-autosuggestions
git clone 'https://github.com/zsh-users/zsh-syntax-highlighting.git' ~/.zsh/zsh-syntax-highlighting

info "${BOLD}Configuring themes and scripts${RESET}"

git clone 'https://gitlab.com/limakos/limos-wallpapers.git'

[ ! -d /usr/share/backgrounds ] && sudo mkdir /usr/share/backgrounds

sudo mv limos-wallpapers /usr/share/backgrounds/

[ ! -d $HOME/.local/bin ] && mkdir $HOME/.local/bin

cp /etc/limos/scripts/* $HOME/.local/bin

[ ! -f $HOME/.xsession ] && touch $HOME/.xsession

$dynamic_them && echo "~/.local/bin/limos-theme" >> $HOME/.xsession
echo "xsetroot -cursor_name left_ptr" >> $HOME/.xsession

if $dynamic_theme; then
    info "Adding cronjob for themes"
    sudo systemctl enable --now cronie.service
    crontab crontab.txt
fi

info "${BOLD}Configuring sddm${RESET}"

dm=$(systemctl show display-manager.service --property=Id --value)

[ "$dm" != "sddm.service" ] && sudo systemctl disable --now $dm

git clone 'https://github.com/MarianArlt/sddm-chili.git'
sudo mv ./sddm-chili /usr/share/sddm/themes/chili

[ -f "/usr/share/sddm/themes/chili/assets/background.jpg" ] && sudo rm "/usr/share/sddm/themes/chili/assets/background.jpg"
sudo cp /usr/share/backgrounds/limos-wallpapers/6.jpg /usr/share/sddm/themes/chili/assets/background.jpg

if [ -f "/usr/lib/sddm/sddm.conf.d/default.conf" ]; then
    sudo cp /usr/lib/sddm/sddm.conf.d/default.conf /usr/lib/sddm/sddm.conf.d/default.conf.backup && \
    sudo sed -i 's/^Current=*.*/Current=chili/g' /usr/lib/sddm/sddm.conf.d/default.conf
fi

if [ -f "/etc/sddm.conf" ]; then
    sudo cp /etc/sddm.conf /etc/sddm.conf.backup
    sudo sed -i 's/^Current=*.*/Current=chili/g' /etc/sddm.conf
fi

[ ! -f "/etc/sddm.conf" ] && sudo cp /usr/lib/sddm/sddm.conf.d/default.conf /etc/sddm.conf

[ "$dm" != "sddm.service" ] && sudo systemctl enable sddm.service

info "${BOLD}Copying LimOS config files${RESET}"

[ -f $HOME/.zshrc ] && mv $HOME/.zshrc $HOME/.zshrc.backup
cp /etc/limos/zsh/zshrc $HOME/.zshrc

[ ! -d $HOME/.config ] && mkdir $HOME/.config
[ -d $HOME/.config ] && mkdir $HOME/.config.backup && cp -rf $HOME/.config $HOME/.config.backup

cp -r /etc/limos/polybar $HOME/.config/
cp -r /etc/limos/xmonad $HOME/.config/
cp -r /etc/limos/rofi $HOME/.config/
cp -r /etc/limos/kitty $HOME/.config/
cp -r /etc/limos/dunst $HOME/.config/
cp -r /etc/limos/picom $HOME/.config/

if ! $dynamic_theme; then
    info "${BOLD}Applying default theme${RESET}"

    path=/usr/share/backgrounds/limos-wallpapers
    polybar_path=~/.config/polybar/config.ini
    xmonad_path=~/.config/xmonad/xmonad.hs
    rofi_powermenu_path=~/.config/rofi/powermenu/powermenu.rasi
    rofi_message_path=~/.config/rofi/powermenu/message.rasi
    rofi_confirm_path=~/.config/rofi/powermenu/confirm.rasi
    rofi_finder_path=~/.config/rofi/config.rasi
    dunst_path=~/.config/dunst/dunstrc

    if [ -f "$polybar_path" ]; then
        sed -i "s/include-file = colors\/[^ ]*/include-file = colors\/colors6.ini/g" "$polybar_path"
    fi

    kitten themes --reload-in=all "color6"

    if [ -f "$xmonad_path" ]; then
        sed -i 's/import Colors\.[^ ]*/import Colors.Colors6/g' "$xmonad_path"
    fi

    if [ -f "$rofi_powermenu_path" ] && [ -f "$rofi_confirm_path" ] && [ -f "$rofi_message_path" ] && [ -f "$rofi_finder_path" ]; then
        sed -i 's/@import "..\/[^"]*"/@import "..\/colors\/colors6.rasi"/g' "$rofi_powermenu_path"
        sed -i 's/@import "..\/[^"]*"/@import "..\/colors\/colors6.rasi"/g' "$rofi_message_path"
        sed -i 's/@import "..\/[^"]*"/@import "..\/colors\/colors6.rasi"/g' "$rofi_confirm_path"
        sed -i 's/@import "[^"]*"/@import "colors\/colors6.rasi"/g' "$rofi_finder_path"
    fi

    if [ -f "$dunst_path" ]; then
        dunst_colors=$HOME/.config/dunst/colors
        bg=$(awk -F= '/background/ {print $2}' "$dunst_colors/colors6.txt")
        fg=$(awk -F= '/foreground/ {print $2}' "$dunst_colors/colors6.txt")
        fr=$(awk -F= '/frame/ {print $2}' "$dunst_colors/colors6.txt")

        sed -i -e 's/background = "#[^"]*"/background = "'"$bg"'"/g' -e 's/foreground = "#[^"]*"/foreground = "'"$fg"'"/g' -e 's/frame_color = "#[^"]*"/frame_color = "'"$fr"'"/g' "$dunst_path" 
    fi
fi

info "${BOLD}Adding network interface to polybar config${RESET}"

network_interface=$(ip -o link show | awk '$9 == "UP" {print $2}' | sed 's/://')

[ -f "$HOME/.config/polybar/config.ini" ] && sed -i 's/interface = .*/interface = '"$network_interface"'/' $HOME/.config/polybar/config.ini

while true; do
    echo -n -e "${BOLD}LimOS is installed do you want to reboot? (Yy Nn): ${BOLDR}"
    read choice

    case $choice in
        [Yy]* ) reboot;;
        [Nn]* ) break;;
        * ) echo "Please answer yes or no."
    esac
done
